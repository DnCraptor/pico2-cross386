#include <pico/stdlib.h>
#include "x86.h"
#include "graphics.h"

/*
Для **минимальной** работы DOS с экраном через `INT 10h` нужны далеко не все функции BIOS-видео.

Вот что **обязательно нужно**, чтобы DOS нормально работал:

---

### Минимально необходимые функции `INT 10h`:

| AH | Функция                        | Назначение                         |
|----|---------------------------------|------------------------------------|
| 00h | Set Video Mode                 | Установить видеорежим (например, 03h — текст 80x25) |
| 01h | Set Cursor Type                | Задать форму курсора              |
| 02h | Set Cursor Position            | Установить позицию курсора         |
| 03h | Read Cursor Position           | Прочитать позицию курсора          |
| 06h | Scroll Window Up               | Прокрутка окна вверх              |
| 07h | Scroll Window Down             | Прокрутка окна вниз               |
| 08h | Read Character and Attribute at Cursor | Прочитать символ и атрибут в позиции курсора |
| 09h | Write Character and Attribute at Cursor | Печать символа с атрибутом (без перемещения курсора) |
| 0Ah | Write Character Only at Cursor | Печать символа без атрибута        |
| 0Eh | Teletype Output                 | Вывод символа на экран и продвижение курсора (используется для обычного вывода текста!) |
| 0Fh | Get Current Video Mode          | Прочитать текущий видеорежим (режим, страницы, ширина экрана) |

---

### Почему именно они:
- **Set/Get Video Mode (00h, 0Fh)** — чтобы DOS мог узнать, что за экран и правильно его использовать.
- **Set/Get Cursor (01h, 02h, 03h)** — DOS много работает с позиционированием курсора.
- **Teletype Output (0Eh)** — основной способ "вывести текст" в стандартном текстовом режиме BIOS.
- **Scroll Up/Down (06h, 07h)** — для прокрутки текста (например, когда экран заполняется).
- **Write/Read Character (08h, 09h, 0Ah)** — при продвинутой печати и редакторах.

> Пример: команды типа `DIR` используют Teletype Output (0Eh) + прокрутку экрана (06h), а при редактировании строк курсор двигают через (02h).

---

### Что можно не поддерживать:
- Функции работы с палитрами, графикой, шрифтами (10h, 11h, 12h и т.п.)
- Многостраничность видео (если игнорировать AH=05h "Set Active Page", пока не требуется).

---
Минимальные видеорежимы для работы DOS:

Режим (AL)	Описание	Нужно ли
03h	Текстовый 80×25, 16 цветов	Обязательно
00h	Текстовый 40×25, 16 цветов	Желательно, но можно пропустить
01h	Текстовый 40×25, 16 цветов (широкий шрифт)	Необязательно
02h	Текстовый 80×25, 16 цветов (широкий шрифт)	Необязательно

*/

inline static u32 x86_int10_hanler_00(u32 eax) {
    // TODO:
    /*
if (mode <= 5 || mode == 7) {
    AL = 0x30;    // текстовые режимы 0-5, 7
} else if (mode == 6) {
    AL = 0x3F;    // режим 6 (640x200 монохромная графика)
} else {
    AL = 0x20;    // все остальные режимы >7
}
    */
    clrScr(0);
    return 0x30; 
}

inline static u32 x86_int10_hanler_01(u32 ecx) {
    text_cursor_type = (u16)ecx;
    return 0;
}

u32 x86_int10_hanler_C(u32 eax, u32 ebx, u32 ecx, u32 edx) {
    goutf(current_video_mode_height - 1, false, "x86_int10_hanler_C(%08X, %08X, %08X, %08X)", eax, ebx, ecx, edx);
    switch (AH) { // AH - function
        case 0:
            return x86_int10_hanler_00(eax);
        case 1:
            return x86_int10_hanler_01(ecx);
    }
    return 0;
}
